@using TinyMCE.Blazor
@using Guide.Common.Static
@using Guide.Application.Features.Attractions.Commands.UpdateAttraction

@page "/admin/attractions/update/{id:int}"
@rendermode InteractiveServer

@inject IAttractionService AttractionService
@inject ICategoryService CategoryService
@inject NavigationManager NavigationManager

<PageTitle>Atrakcje - Panel Administratora</PageTitle>

@if (_request != null)
{
    <div class="row mb-3">
        <div class="col"></div>
        <div class="col-12 col-md-3 col-lg-2">
            <LanguageSwitcher/>
        </div>
    </div>
    <EditForm class="mb-5" Model="_request" OnValidSubmit="HandleSubmit">
        <FluentValidationValidator/>
        <div class="mb-3">
            <label class="form-label">Nazwa</label>
            <InputText class="form-control" @bind-Value="_request.Name">@_request.Name</InputText>
            <ValidationMessage For="() => _request.Name"/>
        </div>
        <div class="mb-3">
            <label class="form-label">Kategorie</label>
            <select class="form-select" multiple @onchange="OnSelectedCategoriesChanged">
                @foreach (var cat in _categories)
                {
                    <option value="@cat.Id" selected=@_request.Categories.Contains(cat.Id)>@cat.Name</option>
                }
            </select>
        </div>
        <div class="mb-3">
            <label class="form-label">Opis</label>
            <Editor Field="() => _request.Description"
                    @bind-Value="_request.Description"
                    ScriptSrc="/js/tinymce/tinymce.min.js"
                    Conf="TinyMceConfig.Config"/>
        </div>
        <button type="submit" class="btn btn-primary">Zapisz</button>
    </EditForm>

    <div class="row">
        <div class="col mb-3">
            <label class="form-label">Zdjęcia</label>
            <InputFile class="form-control" OnChange="OnInputFileChange" multiple/>
        </div>
    </div>

    <div class="row row-gap-3">
        @if (_isProcessingFiles)
        {
            <p>Przesyłanie zdjęć...</p>
        }
        else
        {
            @foreach (var image in _images)
            {
                <div class="col-sm-6 col-lg-4">
                    <div class="card">
                        <div class="row g-0">
                            <div class="col-md-6">
                                <img src="@image.Url" class="img-fluid rounded-start" alt="...">
                            </div>
                            <div class="col-md-6">
                                <div class="card-body">
                                    <div class="form-check mb-3">
                                        <InputCheckbox class="form-check-input" type="checkbox" id="@($"image-{image.Id}")" name="@($"image-{image.Id}")"
                                                       @bind-Value="image.IsMain" @bind-Value:after="@(async () => await OnMainImageChange(image))"/>
                                        <label class="form-check-label" for="image-@image.Id">
                                            Zdjęcie główne
                                        </label>
                                    </div>
                                    <button type="button" class="btn btn-danger" @onclick="@(async () => await DeleteImage(image))">
                                        Usuń
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    [Parameter] public int? Id { get; set; }

    private const int MaxAllowedFiles = 50;

    private UpdateAttractionCommand? _request;
    private List<CategoryDto> _categories = [];
    private List<AttractionImage> _images = [];
    private bool _isProcessingFiles;

    protected override async Task OnInitializedAsync()
    {
        if (!Id.HasValue)
        {
            NavigationManager.NavigateTo("/admin/attractions");
            return;
        }

        var attraction = await AttractionService.Get(Id.Value);
        if (attraction == null)
        {
            NavigationManager.NavigateTo("/admin/attractions");
            return;
        }

        _categories = await CategoryService.GetAll();
        _images = attraction.Images.ToList();

        _request = new UpdateAttractionCommand
        {
            Id = attraction.Id,
            Name = attraction.Name, Description = attraction.Description,
            Categories = attraction.Categories.Select(x => x.Id)
        };
    }

    private async Task HandleSubmit()
    {
        await AttractionService.Update(_request!);
        NavigationManager.NavigateTo("/admin/attractions");
    }

    private void OnSelectedCategoriesChanged(ChangeEventArgs e)
    {
        if (e.Value is not null)
        {
            _request!.Categories = ((string[])e.Value).Select(int.Parse).ToList();
        }
    }

    private async Task OnInputFileChange(InputFileChangeEventArgs e)
    {
        _isProcessingFiles = true;

        var files = e.GetMultipleFiles(MaxAllowedFiles);
        var images = await AttractionService.AddImages(files, _request!.Id);

        _images = images;
        _isProcessingFiles = false;
        await InvokeAsync(StateHasChanged);
    }

    private async Task DeleteImage(AttractionImage image)
    {
        await AttractionService.DeleteImage(image);
        _images.Remove(image);

        await InvokeAsync(StateHasChanged);
    }

    private async Task OnMainImageChange(AttractionImage targetImage)
    {
        await AttractionService.SetImageAsMain(targetImage);

        foreach (var image in _images)
        {
            image.IsMain = image.Id == targetImage.Id;
        }

        await InvokeAsync(StateHasChanged);
    }

}
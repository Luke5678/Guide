@using System.Text.RegularExpressions
@using Guide.Components.Admin.Shared
@using Guide.Domain.Entities

@page "/admin"
@page "/admin/attractions"
@rendermode InteractiveServer

@inject IAttractionService AttractionService
@inject NavigationManager NavigationManager

<PageTitle>Atrakcje - Panel Administratora</PageTitle>

<div class="d-flex mb-3">
    <a class="btn btn-primary" href="admin/attractions/create">
        Nowa atrakcja
    </a>
</div>

@if (Attractions == null)
{
    <div>...</div>
}
else
{
    <div class="table-responsive">
        <table class="table align-middle table-striped table-bordered table-hover">
            <thead>
                <tr>
                    <th @onclick="@(async () => await ChangeOrder("id"))">
                        Id
                    </th>
                    <th @onclick="@(async () => await ChangeOrder("category"))">
                        Kategoria
                    </th>
                    <th @onclick="@(async () => await ChangeOrder("name"))">
                        Nazwa
                    </th>
                    <th/>
                </tr>
            </thead>
            <tbody>
                @foreach (var attraction in Attractions)
                {
                    <tr>
                        <td>@attraction.Id</td>
                        <td>@attraction.Category</td>
                        <td>@attraction.Name</td>
                        <td>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" @onclick="() => Edit(attraction)">
                                    Edytuj
                                </button>
                                <button class="btn btn-danger" @onclick="() => Delete(attraction)">
                                    Usuń
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <ComPagination CurrentPage="Page" PagesAmount="PagesAmount" OnPageChanged="async page => await ChangePage(page)"/>
}

@code {
    [Parameter] [SupplyParameterFromQuery] public int Page { get; set; }
    [Parameter] [SupplyParameterFromQuery] public int Limit { get; set; }
    [Parameter] [SupplyParameterFromQuery] public string? OrderBy { get; set; }
    List<Attraction>? Attractions { get; set; }
    int PagesAmount { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadAttractions();
        Console.WriteLine($"\n\n\n init \n\n\n");
    }

    async Task LoadAttractions()
    {
        if (Limit < 5) Limit = 10;
        else if (Limit > 50) Limit = 50;

        PagesAmount = (int)Math.Ceiling(await AttractionService.GetCount() / (double)Limit);

        if (Page < 1) Page = 1;
        else if (Page > PagesAmount) Page = PagesAmount;

        Attractions = await AttractionService.GetAll(Page, Limit, OrderBy);

        await InvokeAsync(StateHasChanged);
    }

    void Edit(Attraction attraction)
    {
        NavigationManager.NavigateTo($"/admin/attractions/update/{attraction.Id}");
    }

    async Task Delete(Attraction attraction)
    {
        await AttractionService.Delete(attraction.Id);
        await LoadAttractions();
    }

    async Task ChangePage(int? newPage = null)
    {
        Page = newPage ?? Page;
        var uri = $"/admin/attractions?page={Page}&limit={Limit}";

        if (!string.IsNullOrEmpty(OrderBy))
        {
            uri += $"&orderBy={OrderBy}";
        }

        await LoadAttractions();
        NavigationManager.NavigateTo(uri);
    }

    async Task ChangeOrder(string column)
    {
        var rg = new Regex($"^{column} (asc|desc)$", RegexOptions.IgnoreCase);

        if (string.IsNullOrEmpty(OrderBy) || !rg.IsMatch(OrderBy))
        {
            OrderBy = $"{column} asc";
        }
        else
        {
            var dir = OrderBy.Split(" ")[1];
            OrderBy = dir.ToLower() == "asc" ? $"{column} desc" : $"{column} asc";
        }

        await ChangePage();
    }

}